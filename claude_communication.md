# コミュニケーション用の項目
はい、これは魚の描画マスター・スレーヴシステムです。
さらに、モニタースクロールシステムを開発しました。
サンプルプログラムはscroll_sampleディレクトリにあります。
このサンプルプログラムの特徴はIMUを使用していることです。
これらのシステムを統合したいと考えています。
現在のディレクトリのプロジェクトは、スクロール機能を考慮しています。
ただし、スクロールの位置はマスターが指示します。（0x01の2byte~9byteまで）
スレーヴは次のようなフォーマットでデータをマスターに送信します。加速度のデータは7byte~16byteまでが割り当てられています。
マスターが、加速度データからデバイスの傾き・姿勢を検出して、スクロールを開始します。

マスターからスレーヴに送られてくるデータのプロトコルは、CLAUDE.md.backupをご覧ください。

## スレーヴからマスターから送信するシリアルのプロトコル

| 1バイトint データ配列pos | データ意味 | 詳細説明 | 備考 |
|---|---|---|---|
| 0 | 先頭バイト | データ解析に転送性を もたせるための1バイト | 0x01で固定 データのプロトコル追加しなければ意味なし |
| 1 | | | |
| 2 | | | |
| 3 | 4バイトunsigned int | 非等間隔サンプリングの補正に | Arduinoでは[millis]で取得 |
| 4 | タイムスタンプ | もしかした後うかも | 50日くらいでオーバーフローするらしい |
| 5 | | | |
| 6 | 2バイトint 粗加速度 | 0=0x0000でOG 32767=0x7FFFで+4G -32768=0x8000で-4G | 16bitで±4GがIMU(MPU6886)のデフォルト G単位のfloatで取得したときは、 32767/4倍してバイトintにキャスト |
| 7 | | | |
| 8 | 2バイトint y軸加速度 | 0=0x0000でOG 32767=0x7FFFで+4G -32768=0x8000で-4G | 16bitで±4GがIMU(MPU6886)のデフォルト G単位のfloatで取得したときは、 32767/4倍してバイトintにキャスト |
| 9 | | | |
| 10 | 2バイトint z軸加速度 | 0=0x0000でOG 32767=0x7FFFで+4G -32768=0x8000で-4G | 16bitで±4GがIMU(MPU6886)のデフォルト G単位のfloatで取得したときは、 32767/4倍してバイトintにキャスト |
| 11 | | | |
| 12 | 2バイトint ロール角速度 | 0=0x0000で0deg/s 32767=0x7FFFで+2000deg/s -32768=0x8000で-2000deg/s | 16bitで±2000deg/sがIMU(MPU6886)のデフォルト deg/s単位のfloatで取得したときは、 32767/2000倍してバイトintにキャスト |
| 13 | | | |
| 14 | 2バイトint ピッチ角速度 | 0=0x0000で0deg/s 32767=0x7FFFで+2000deg/s -32768=0x8000で-2000deg/s | 16bitで±2000deg/sがIMU(MPU6886)のデフォルト deg/s単位のfloatで取得したときは、 32767/2000倍してバイトintにキャスト |
| 15 | | | |
| 16 | 2バイトint ヨー角速度 | 0=0x0000で0deg/s 32767=0x7FFFで+2000deg/s -32768=0x8000で-2000deg/s | 16bitで±2000deg/sがIMU(MPU6886)のデフォルト deg/s単位のfloatで取得したときは、 32767/2000倍してバイトintにキャスト |
| 17 | ボタン状態 | 0bit目はボタンA、 1bit目はボタンB | array[17] = 0x03 | ( (char)B<<1 | (char)A ); でセットする。A,B状ON=1, OFF=0 |


## 実施すること
- スレーヴからマスターへのデータ送信に対応する。
- マスターのプログラム（Pythonプログラム、py_sender_scriptを参照のこと）に、傾きとスクロール指示を行うように改変する。
- スレーヴは画面スクロール機能に対応する。

# 試作に関する追記1
実装いただきありがとうございます。
Pythonの方のプログラムについて、スクロール位置の演算に不備があります。
加速度は正しく取れていますが、スクロールが正しく演算できていないように思います。次のように処理できているか確認してください。

1. 加速度・角速度をパースする。（正常な動作の確認済み）
2. 加速度ら定常姿勢（ロール、ピッチ）推定の演算を行う。
3. 姿勢にバンドパスフィルタをかけ、傾き角が定常かどうかの検出を行う。
4. 傾いている方位に向かって一定の力が入るようなイメージでスクロールする。（1次のLPFによる慣性モデリング）

# 試作に関する追記2

2. 加速度ら定常姿勢（ロール、ピッチ）推定の演算を行う。
のところについて、ローパスフィルタはモジュール側で実施済みなので不要です。

3. 姿勢にバンドパスフィルタをかけ、傾き角が定常かどうかの検出を行う。
のところについて、演算に問題があるようです。
- STILLと表示されている一方で、スクロール移動量が小さすぎます。45度以上傾けてもScrollの値がほとんど動きません。
- また、速度Velの演算が不正です。水平状態でも速度が残り続けています。

また、追加の機能で、ほぼ水平と思われるとき（傾き角が15度以内）のときは、定常(STILL)であっても、加速度を与えないようにします。



# 試作に関する追記3
Pythonのマスタープログラムの方は、意図通りの動作ができました。
続けて、モジュールのC++コードの方ですが、背景も金魚と同様にスクロールさせたいです。
背景は既に設定してある画像を上下左右に周期的にタイル状に並べてください。
ただし、スクロールで許容する範囲は、480×480の領域の3倍、したがって1440×1440にします。
Pythonのマスターの方も、スクロールエリアを制限するようにしてください。

# 試作に関する追記4
ここまでの成果"fish_sender_with_imu_scroll.py"について、
ESP32で動くArduinoプログラムに移植してください。
なお、カレントディレクトリのPlatformIOのスレーブサイドのプロジェクトプログラムは**絶対に改変しない**でください。
ESP32-master.inoファイルを作成し、Arduinoファイルとして記述してください。

## inoファイルのテンプレート

```cpp
# include <Arduino.h>

void setup()
{

}

void loop()
{
    delay(10);
}
```

